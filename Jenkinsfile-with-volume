pipeline {
agent {
  kubernetes {
    inheritFrom 'python-inherit-dynamic-volume'
    cloud "openshift"
  }
}

  stages {

    stage('Checkout Pipeline Source') {
     steps {
       echo "Checking out Code}"
       checkout scm
      }     
    }


    stage('Clone Application Source') {
     steps {
       echo "Clone our Application Source Code}"
       script {             
             sh "git clone ${REPO}"
          }
      }     
    }
    // Commenting out Unit Test Due to Python Version
    // stage('Run Unit Testing') {
    //  steps {
    //    echo "Starting Unit Testing"
    //    script {
    //      try {
    //        sh "python ./testFlask/test.py"
    //      } catch (Exception e) {
    //        error("Build failed at Unittest")
    //      }
    //    echo "Unittest Passed"
    //    }
    //   }     
    // }
    //You can run steps in different containers if you choose 
    // with the container('container_name') but according to the docs it defaults to non-jnlp container which works for this use-case
    stage('Create Test Version of Application') {
     steps {
       script {
         openshift.withCluster() {
           openshift.withProject( "${JENKINS_NAMESPACE}" ){
           echo "Creating Mysql Application"
           def fromJSON = openshift.create( readFile( 'mysql.json' ) )
           
           echo "Creating Mysql Service"
           def fromJSON2 = openshift.create( readFile( 'mysql-svc.json' ) )

           echo "Wait until dc/mysql is available"
           def dcmysql = openshift.selector('dc', "mysql")
           dcmysql.rollout().status()
           echo "dc/mysql is available"
           
           echo "Creating Main Application"
           apply = openshift.apply(openshift.raw("new-app ${REPO} --name=${APP_NAME} -l app=${APP_NAME} --env=APP_CONFIG=${APP_CONFIG} --env=APP_MODULE=${APP_MODULE} --env=MYSQL_HOST=${MYSQL_HOST} --env=MYSQL_DATABASE=${MYSQL_DATABASE} --as-deployment-config=true --strategy=source --dry-run --output=yaml").actions[0].out)
           //openshift.newApp('https://github.com/MoOyeg/testFlask.git')
           echo "Created Main Application"
             
           echo "Configure Main Application"
           openshift.raw("set env dc/${APP_NAME} --from=secret/my-secret")
           openshift.raw("expose svc/${APP_NAME}")
           openshift.raw("expose svc/mysql")
           openshift.raw("label dc/mysql app=${APP_NAME}")
           openshift.raw("label dc/${APP_NAME} app.kubernetes.io/part-of=${APP_NAME}")
           openshift.raw("label dc/mysql app.kubernetes.io/part-of=${APP_NAME}")
           openshift.raw("annotate dc/${APP_NAME} app.openshift.io/connects-to=mysql")
           echo "Configured Main Application"

           echo "Wait until dc/${APP_NAME} is available"
           def dcmainapp = openshift.selector('dc', "${APP_NAME}")
           dcmainapp.rollout().status()
           echo "dc/${APP_NAME} is available"

          }
         }
       }

      }     
    }

    stage('Data Testing with Volumes') {
     steps {
      echo "Obtain Workspace Volume Location"
        script {
        VOLUME_PVC = sh (
          script: 'oc get pod/$(hostname) -o jsonpath=\'{$.spec.volumes[?(@.name == "workspace-volume")].persistentVolumeClaim.claimName}\'',
          returnStdout: true
        )
        echo "Workspace Volume obtained was ${VOLUME_PVC}"
        echo "Attach Volume ${VOLUME_PVC} to our MySQL DB"
        sh "oc set volume dc/mysql --add --name=v1 -t pvc --claim-name=${VOLUME_PVC} --mount-path=/var/test/data --overwrite -n ${JENKINS_NAMESPACE}"
        
        echo "Wait Till Pod Ready"
        sh "oc rollout status dc/mysql -w -n ${JENKINS_NAMESPACE}"

        echo "Get MySQL Pod Name"
        MYSQL_POD= sh (
          script: "oc get pods -l deploymentconfig=mysql -n ${JENKINS_NAMESPACE} -o name",
          returnStdout: true
        )        
        echo "Attempt to import data stored in WorkSpace Volume Pulled from Git"
        sh "echo \"mysql -u root testdb < /var/test/data/workspace/${JENKINS_NAMESPACE}/${JENKINS_NAMESPACE}-${APP_NAME}-pipeline-volume/testdb.sql\" >> /home/jenkins/agent/workspace/${JENKINS_NAMESPACE}/${JENKINS_NAMESPACE}-${APP_NAME}-pipeline-volume/testdb-import.sh"
        //sh "oc exec -n ${JENKINS_NAMESPACE} ${MYSQL_POD} -t -- mysql -u root < /var/test/data/workspace/${JENKINS_NAMESPACE}/${JENKINS_NAMESPACE}-${APP_NAME}-pipeline-volume/testdb.sql"
        }

     }
    }
    
    stage('Run System Testing') {
     steps {
       echo "Starting System Testing"
       script {
         echo "Obtain ${APP_NAME} service"
         def svc_name = "http://${APP_NAME}.${JENKINS_NAMESPACE}.svc:8080"
        //def latestDeploymentVersion = openshift.selector('dc',"simple-python").object().status.latestVersion       
         echo "Test Application Status Code == 200"         
         status_code1 = sh (script: "curl -s -o /dev/null -w \"%{http_code}\" ${svc_name}",returnStdout: true)
         echo "${status_code1}"
         if ( "${status_code1}" == "200" ){
           echo "Application Passed Service Response Test"
         } else {
           error("Application Failed Service Response Test")
         }

       }
      }           
    } 
    
    stage('Approve Promotion to Production') {
      steps {
        timeout(time: 30, unit: 'DAYS') {
        input message: "Promote Application to Production?"
      }
     }
    }

    stage('Promoting Application Code to Production') {
     steps {
       echo "Tagging Application Code For Stable Production"
       script {
         openshift.withCluster() {
         openshift.tag( '${JENKINS_NAMESPACE}/${APP_NAME}:latest', '${PROD_PROJECT}/${APP_NAME}:latest')
         }
       echo "Application Promoted to Production"
       }
      }     
    }

    // Using Openshift.raw example moved to post section below
    // stage('Remove all Deployments and Services in Testing Project') {
    //  steps {
    //    echo "Removing Deployments and Services for project ${JENKINS_NAMESPACE}"
    //    script {
    //      openshift.withCluster() {
    //        openshift.raw("delete dc/mysql -n ${JENKINS_NAMESPACE}")
    //        openshift.raw("delete svc/mysql -n ${JENKINS_NAMESPACE}")
    //        openshift.raw("delete dc/${APP_NAME} -n ${JENKINS_NAMESPACE}")
    //        openshift.raw("delete svc/${APP_NAME} -n ${JENKINS_NAMESPACE}")
    //        openshift.raw("delete route/${APP_NAME} -n ${JENKINS_NAMESPACE}")
    //      }
    //    echo "Application Promoted to Production"
    //    }
    //   }     
    //  }
  }

  post { 
    always {
      echo "Removing Deployments and Services for project  ${JENKINS_NAMESPACE}"
      sh "oc delete dc/mysql -n ${JENKINS_NAMESPACE}&> /dev/null || Did not delete dc/mysql or does not exist"
      sh "oc delete svc/mysql -n ${JENKINS_NAMESPACE} &> /dev/null || Did not delete svc/mysql or does not exist"
      sh "oc delete dc/${APP_NAME} -n ${JENKINS_NAMESPACE} &> /dev/null || Did not delete dc/${APP_NAME} or does not exist"
      sh "oc delete svc/${APP_NAME} -n ${JENKINS_NAMESPACE} &> /dev/null || Did not delete svc/${APP_NAME} or does not exist"
      sh "oc delete route/${APP_NAME} -n ${JENKINS_NAMESPACE} &> /dev/null || Did not delete route/${APP_NAME} or does not exist"
      sh "oc delete route/mysql -n ${JENKINS_NAMESPACE} &> /dev/null || Did not delete route/mysql or does not exist"
      echo "Application Promoted to Production"
    }
  }
}
